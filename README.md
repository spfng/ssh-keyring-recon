# SSH Keyring Recon

Набор инструментов для создания децентрализованной p2p-сети между хостами с использованием bash, ssh и nginx (или любого другого веб-сервера).

Главная идея заключается в обмене приватными ssh-ключами между хостами с использованием секретной фразы, по которой будет доступен ключ для скачивания, после чего хосты получают доступ друг к другу и возможность обмена данными.

Разместив это на каждом хосте -- каждый хост будет предоставлять доступ к ssh-ключу, доступ к которому может получить лишь администратор сети, зная секретную фразу.

Каждый хост может получать ssh-ключи других хостов в сети.

Далее, каждый хост, при подключении к новой сети, будет загружать ключи с других хостов оттуда.

И далее, все хосты друг с другом могут синхронизировать данные, получаемые из других сетей.

Получается так, что хост A знает ключ хоста B, а хост B подключен к сети, где есть хост C.

Хост A синхронизирует данные с хостом B и теперь хост A знает ключ хоста C, при этом не имея к нему прямого доступа из сети.

Можно оставить записку на хосте A, чтобы выполнить команду на хосте C, и когда хост B синхронизирует данные с хостом A, а далее хост C получит данные от хоста B, то хост C увидит записку, которая предназначена ему и сможет выполнить запрошенную команду хостом A.

Таким образом мы получаем реализацию децентрализованной p2p-сети, где каждый хост это и master, и slave одновременно, где все участники равноценны между собой и могут сообщаться друг с другом, будучи при этом даже не подключены в одну локальную сеть.

Быстрый запуск:

```
# ssh_keyring_generate.sh
# ssh_keyring_populate.sh
# ssh_keyring_scanner.sh 127.0.0.1 | ssh_keyring_download.sh
127.0.0.1
# ssh -i ~/ssh-keyring/bf303ab85d57beeb5327f7496719ba6689e2823dec8f477ae6b70f78557aa33c/id_ed25519 root@127.0.0.1
```

1) ssh_keyring_generate.sh -- генерирует пару (приватный и публичный) ssh-ключей и разрешает доступ, копируя публичный ключ в файл authorized_keys.

Рекомендуется использовать в сценарии при каждой загрузке системы, например добавить в /etc/crontab событие @reboot, которое выполняется единоразово при каждой загрузке системы:

```
@reboot root $HOME/.local/bin/ssh_keyring_generate.sh
```

2) ssh_keyring_populate.sh -- копирует пару (приватный и публичный) ssh-ключей в папку /var/www/html открывая общий доступ к ним.

Здесь используется генерация хэша, с использованием IP-адреса системы и секретной фразы.

Командой hostname -I узнаются все IP-адреса, по которым доступен хост. Далее генерируется sha256 хэш-сумма, которая состоит из каждого IP-адреса в отдельности и добавляется секретная фраза, например:

```
# sha256sum <<< "127.0.0.1 + password"
bf303ab85d57beeb5327f7496719ba6689e2823dec8f477ae6b70f78557aa33c  -
```

Таким образом все ssh-ключи расположены по адресу:

`http://localhost/ssh-keyring/bf303ab85d57beeb5327f7496719ba6689e2823dec8f477ae6b70f78557aa33c/id_ed25519`
`http://localhost/ssh-keyring/bf303ab85d57beeb5327f7496719ba6689e2823dec8f477ae6b70f78557aa33c/id_ed25519.pub`

Публичный IP-адрес известен всем, а секретная фраза только администратору системы.

И таких дубликатов ключей создаётся несколько, для каждого публичного IP-адреса, который имеется в системе, чтобы была возможность коллекционировать ключи находясь в разных сетях.

Рекомендуется запускать через /etc/crontab каждую минуту, чтобы при подключении хоста к новой сети -- ключи автоматически копировались для доступа из новой сети.

```
* * * * * root $HOME/.local/bin/ssh_keyring_populate.sh
```

3) ssh_keyring_scanner.sh -- сетевой сканер, который проверяет сеть на наличие запущенного веб-сервера (80 порт). Сканер использует утилиту nc для проверки порта на доступность, запуская её в фоновом режиме, таким образом за раз можно запустить неограниченное количество проверок, например, проверить всю /24 подсеть (255 хостов) за раз, что по времени займёт меньше секунды, но специально создано ограничение, и хосты проверяются пачками по 10 штук за раз с промежутком в 1 секунду, -- данное ограние можно легко убрать или смягчить при необходимости.

Сканер выводит список IP-адресов, где запущен веб-сервер. Из-за того, что сканер работает в фоновом режиме, работа сканера завершается раньше, чем завершается вывод утилиты nc, поэтому рекомендуется использовать запись IP-адресов в файл, а не вывод в терминал, но в этом нет ничего страшного.

Для работы сканер сперва раскладывает подсеть (CIDR) на все IP-адреса, а затем проверяет каждый в отдельности.

```
# ssh_keyring_scanner.sh 127.0.0.1/32 192.168.0.0/24
```

Просканирует локальный IP-адрес и все адреса в 192.168.0.0/24 подсети.

4) ssh_keyring_download.sh -- каждый просканированный IP-адрес необходимо проверить на наличие у него ssh-ключа по известному адресу, можно использовать в паре со сканером.

```
# ssh_keyring_scanner.sh 192.168.0.0/24 | ~/.local/bin/ssh_keyring_download.sh
```

Все найденные ssh-ключи будут загружены в ~/ssh-keyring/, после чего можно получить доступ к любому удалённому хосту привычной командой ssh:

```
# ssh -i ~/ssh-keyring/bf303ab85d57beeb5327f7496719ba6689e2823dec8f477ae6b70f78557aa33c/id_ed25519 root@127.0.0.1
```

---
SSH Keyring Recon
